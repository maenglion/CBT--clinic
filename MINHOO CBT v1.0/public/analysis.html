<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¯¼í›„ì˜ ëŒ€í™” ë¶„ì„ (í†µí•©)</title>
  <link rel="stylesheet" href="style.css"> 
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'KoPubWorld Dotum', sans-serif;
      background-color: #f4f7f6;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    .container {
      background-color: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 800px; 
      margin: 0 auto;
      text-align: left;
    }
    h1 {
      text-align: center;
      color: #0095FF;
      margin-bottom: 25px;
    }
    
    /* íƒ­ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
    .tabs {
      display: flex; /* ë²„íŠ¼ë“¤ì„ ê°€ë¡œë¡œ ë‚˜ì—´ */
      width: 100%; /* íƒ­ ì»¨í…Œì´ë„ˆ ì „ì²´ ë„ˆë¹„ ì‚¬ìš© */
      margin-bottom: 20px;
      border-bottom: 2px solid #0095FF;
    }
    .tab-button {
      flex-grow: 1; /* ê° ë²„íŠ¼ì´ ë™ì¼í•œ ë„ˆë¹„ë¥¼ ê°€ì§€ë„ë¡ í•¨ (1/2ì”©) */
      text-align: center; /* ë²„íŠ¼ ë‚´ í…ìŠ¤íŠ¸ ê°€ìš´ë° ì •ë ¬ */
      padding: 12px 10px; /* íŒ¨ë”© ì¡°ì • */
      cursor: pointer;
      border: none;
      background-color: transparent;
      font-size: 1.1em;
      font-weight: bold;
      color: #B6B6B6; /* ë¹„í™œì„± íƒ­ ê¸€ì”¨ìƒ‰ ë³€ê²½ */
      border-bottom: 3px solid transparent; 
      margin-bottom: -2px; 
      transition: color 0.3s, border-bottom-color 0.3s; /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ */
    }
    .tab-button:hover {
      color: #007bff; /* í˜¸ë²„ ì‹œ ìƒ‰ìƒ (í™œì„± íƒ­ ìƒ‰ìƒê³¼ ìœ ì‚¬í•˜ê²Œ) */
    }
    .tab-button.active {
      color: #0095FF; /* í™œì„± íƒ­ ê¸€ì”¨ìƒ‰ (ë©”ì¸ ìƒ‰ìƒ) */
      border-bottom: 3px solid #0095FF; 
    }
    .tab-content {
      display: none; 
    }
    .tab-content.active {
      display: block; 
    }

    .section-title {
      font-size: 1.3em;
      font-weight: bold;
      color: #333;
      margin-top: 20px;
      margin-bottom: 10px;
      border-bottom: 2px solid #0095FF;
      padding-bottom: 5px;
    }
    .section-title-deep { 
      font-size: 1.4em;
      font-weight: bold;
      color: #007bff; 
      margin-top: 30px;
      margin-bottom: 15px;
      border-bottom: 2px solid #007bff;
      padding-bottom: 8px;
    }

    .conversation-log {
      background-color: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: 1.6;
    }
    .conversation-log p { margin-bottom: 10px; }
    .conversation-log .user-message strong { color: #28a745; }
    .conversation-log .assistant-message strong { color: #17a2b8; }
    .conversation-log .system-message strong { color: #6c757d; }

    .audio-info, .emotion-summary-content {
      margin-top: 10px;
      font-size: 1em;
      background-color: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
    }
    .emotion-summary-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .emotion-chart-container {
        width: 100%;
        max-width: 500px;
        height: 300px;
        margin: 0 auto;
    }
    .emotion-text-summary { width: 100%; }
    .emotion-summary-content ul {
      list-style-type: none;
      padding-left: 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }
    .emotion-summary-content li {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 4px;
      background-color: #e9ecef;
    }
    .emotion-summary-content li.joy strong { color: #ffc107; }
    .emotion-summary-content li.sadness strong { color: #007bff; }
    .emotion-summary-content li.anger strong { color: #dc3545; }
    .emotion-summary-content li.anxiety strong { color: #6f42c1; }

    .important-utterance-card {
      background-color: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-left: 5px solid #0095FF;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 25px;
    }
    .utterance-text {
      font-size: 1.1em;
      line-height: 1.7;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px dashed #ccc;
    }
    .utterance-text strong { color: #28a745; }
    .analysis-section { margin-top: 10px; }
    .analysis-section h4 { font-size: 1.05em; color: #333; margin-top: 15px; margin-bottom: 8px; }
    .analysis-section p, .analysis-section ul { font-size: 0.95em; line-height: 1.6; color: #555; margin-bottom: 10px; }
    .analysis-section ul { padding-left: 20px; }
    .placeholder-note { font-style: italic; color: #777; font-size: 0.9em; }
    .loading-message { text-align: center; padding: 20px; font-size: 1.1em; color: #555; }
    
    .button-container { text-align: center; margin-top: 30px; }
    .btn-journal, .btn-back {
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        border: none;
        cursor: pointer;
    }
    .btn-journal { background-color: #0095FF; color: white; }
    .btn-journal:hover { background-color: #0077cc; }
    .btn-back { background-color: #D2E9FF; color: #333; } 
    .btn-back:hover { background-color: #b8d8f5; }

    .conversation-log::-webkit-scrollbar { width: 8px; }
    .conversation-log::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .conversation-log::-webkit-scrollbar-thumb { background: #0095FF; border-radius: 10px; }
    .conversation-log::-webkit-scrollbar-thumb:hover { background: #0077cc; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ë¯¼í›„ì˜ ëŒ€í™” ë¶„ì„</h1>

    <div class="tabs">
      <button class="tab-button active" data-tab="sentimentAnalysis">ê¸°ë¶„ ë¶„ì„</button>
      <button class="tab-button" data-tab="keyUtteranceAnalysis">ì£¼ìš” ë°œí™” ë¶„ì„</button>
    </div>

    <div id="sentimentAnalysis" class="tab-content active">
      <div class="section-title">ëŒ€í™” ë‚´ìš© ë‹¤ì‹œë³´ê¸°</div>
      <div id="conversation-display-sentiment" class="conversation-log">
        <p>ëŒ€í™” ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>

      <div class="section-title">ê°ì • ë¶„ì„ ìš”ì•½</div>
      <div id="emotion-analysis-summary" class="emotion-summary-container">
        <div class="emotion-chart-container">
          <canvas id="emotionChart"></canvas>
        </div>
        <div id="emotion-text-details" class="emotion-summary-content emotion-text-summary">
          <p>ê°ì • ë¶„ì„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
      </div>

      <div class="section-title">ìŒì„± ì •ë³´ (ì°¸ê³ ìš©)</div>
      <div id="audio-level-display-sentiment" class="audio-info">
        <p>ë§ˆì§€ë§‰ ëŒ€í™”ì˜ ì†Œë¦¬ í¬ê¸°: <span>ì •ë³´ ì—†ìŒ</span></p>
      </div>
    </div>

    <div id="keyUtteranceAnalysis" class="tab-content">
      <p style="text-align: center; margin-bottom: 20px; color: #555;">
        ë¯¼í›„ì˜ ëŒ€í™” ì¤‘ íŠ¹ë³„íˆ ì£¼ëª©í•  ë§Œí•œ ë¶€ë¶„ì„ ìì„¸íˆ ì‚´í´ë´…ë‹ˆë‹¤.<br>
        <span class="placeholder-note">(í˜„ì¬ ìŒì„± í¬ê¸°/ê°•ì„¸ ë¶„ì„ ë° ì´ì „ ëŒ€í™” íŒ¨í„´ ë¹„êµ ê¸°ëŠ¥ì€ ê°œë°œ ì˜ˆì •ì…ë‹ˆë‹¤.)</span>
      </p>
      <div id="analysis-results-key" class="key-utterance-results">
        <p class="loading-message">ì£¼ìš” ë°œí™” ë¶„ì„ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
    </div>
    
    <div class="button-container">
      <button id="btn-save-journal" class="btn-journal">ê°ì •ì¼ê¸°ë¡œ ìš”ì•½í•˜ê¸°</button>
      </div>
  </div>

  <script type="module">
    import { getGptResponse } from './js/gpt-dialog.js'; 

    function setSampleDataForTesting() {
      const sampleConversation = [
        { role: "user", content: "ì˜¤ëŠ˜ í•™êµì—ì„œ ì¹œêµ¬ë‘ ì‹¸ì› ì–´. ë„ˆë¬´ ì†ìƒí•´. ì •ë§ í™”ë‚˜!" },
        { role: "assistant", content: "ì¹œêµ¬ë‘ ì‹¸ì›Œì„œ ì •ë§ ì†ìƒí–ˆê² ë‹¤. ì–´ë–¤ ì¼ ë•Œë¬¸ì— ì‹¸ìš°ê²Œ ëœ ê±°ì•¼? ê±±ì •ë¼." },
        { role: "user", content: "ë‚´ê°€ ì•„ë¼ëŠ” ì—°í•„ì„ ì¹œêµ¬ê°€ í—ˆë½ë„ ì—†ì´ ê°€ì ¸ê°€ì„œ ì¼ì–´. ê·¸ë˜ì„œ ë‚´ê°€ ì—„ì²­ í™”ëƒˆë”ë‹ˆ ì¹œêµ¬ë„ ê°™ì´ í™”ëƒˆì–´. ë„ˆë¬´ ì–µìš¸í•´. ì”¨ë°œ ì§„ì§œ ì§œì¦ë‚˜." },
        { role: "assistant", content: "ì•„ë¼ëŠ” ë¬¼ê±´ì„ í•¨ë¶€ë¡œ ì¨ì„œ í™”ê°€ ë§ì´ ë‚¬êµ¬ë‚˜. 'ì”¨ë°œ' ê°™ì€ ë§ì„ ì“°ë©´ ì¹œêµ¬ë„ ë” ì†ìƒí•  ìˆ˜ ìˆì–´. ê·¸ë˜ë„ ì¹œêµ¬ì—ê²Œ ë¨¼ì € ë„¤ ë§ˆìŒì„ ì˜ ì´ì•¼ê¸°í•´ë³´ëŠ” ê±´ ì–´ë•Œ? 'ë„¤ê°€ ë‚´ ì—°í•„ì„ ë§ë„ ì—†ì´ ì¨ì„œ ì†ìƒí–ˆì–´. ë‹¤ìŒë¶€í„°ëŠ” ë¨¼ì € ë¬¼ì–´ë´ ì£¼ë©´ ì¢‹ê² ì–´.' ì´ë ‡ê²Œ ë§ì´ì•¼. ê·¸ë¦¬ê³  ì¹œêµ¬ê°€ ì‚¬ê³¼í•˜ë©´ ë„ˆë„ í™”ë‚¸ ê²ƒì— ëŒ€í•´ ë¯¸ì•ˆí•˜ë‹¤ê³  ë§í•˜ë©´ ë‹¤ì‹œ ì¹œí•˜ê²Œ ì§€ë‚¼ ìˆ˜ ìˆì„ ê±°ì•¼. ê¸°ë¶„ ì¢‹ì•„ì¡Œìœ¼ë©´ ì¢‹ê² ë‹¤! ë„ˆë¬´ ë¶ˆì•ˆí•´í•˜ì§€ë§ˆ." },
        { role: "user", content: "ì‘, ê·¸ë ‡ê²Œ ë§í•´ë³¼ê²Œ. ì•Œë ¤ì¤˜ì„œ ê³ ë§ˆì›Œ! ì´ì œ ì¢€ ê¸°ë¶„ì´ ë‚˜ì•„ì¡Œì–´. ì‹ ë‚˜! ì™„ì „ ìµœê³ ì•¼!" },
        { role: "assistant", content: "ë‹¤í–‰ì´ë‹¤! ë¯¼í›„ê°€ ì¹œêµ¬ë‘ ì˜ í™”í•´í•˜ê³  ë‹¤ì‹œ ì¦ê²ê²Œ ì§€ë‚´ë©´ ì¢‹ê² ì–´. ë˜ í˜ë“  ì¼ ìˆìœ¼ë©´ ì–¸ì œë“ ì§€ ë‚˜í•œí…Œ ì´ì•¼ê¸°í•´ë„ ê´œì°®ì•„! í–‰ë³µí•œ í•˜ë£¨ ë³´ë‚´!" }
      ];
      const sampleAudioLevel = "0.72"; 
      localStorage.setItem('fullConversation', JSON.stringify(sampleConversation));
      localStorage.setItem('analysisAudioLevel', sampleAudioLevel);
      console.log("ğŸ§ª í…ŒìŠ¤íŠ¸ìš© ì˜ˆì‹œ ë°ì´í„°ê°€ localStorageì— ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
    
    function analyzeOverallEmotions(history) {
      const emotions = {
        joy: { keywords: ['í–‰ë³µ', 'ì‹ ë‚˜', 'ë¿Œë“¯', 'ê°ì‚¬', 'ë§Œì¡±', 'ì¢‹ì•„', 'ì¦ê±°', 'ê¸°ëŒ€', 'í¸ì•ˆ', 'ì•ˆì‹¬', 'ì‚¬ë‘', 'ì›ƒê²¨', 'ìµœê³ ', 'ë‚˜ì•„ì¡Œì–´', 'ë‹¤í–‰', 'ì¬ë¯¸ìˆ', 'í›Œë¥­', 'ë©‹ì ¸', 'ì™„ì „ ìµœê³ ì•¼'], count: 0, found: new Set() },
        sadness: { keywords: ['ì™¸ë¡œ', 'ìš°ìš¸', 'ì„œìš´', 'ìƒì²˜', 'ì†ìƒ', 'í—ˆì „', 'ìŠ¬í¼', 'ëˆˆë¬¼', 'ë¬´ê¸°ë ¥', 'ì§€ì³¤ì–´', 'ê³µí—ˆ', 'ë²„ë ¤ì§„', 'ì‹¤ë§'], count: 0, found: new Set() },
        anger: { keywords: ['í™”ë‚˜', 'ì§œì¦', 'ì–µìš¸', 'ë‹µë‹µ', 'ì‹«ì–´', 'ì†ì´ ë’¤ì§‘', 'ë¬´ì‹œ', 'ì¡´ì¤‘ë°›ì§€ ëª»', 'ë¶€ë‹¹', 'ëª»ì°¸ê² ', 'ì°¸ê¸° í˜ë“ ', 'ë¶„ë…¸', 'ë¯¸ì›Œ', 'ì‹¸ì› ì–´', 'í™”ëƒˆë”ë‹ˆ', 'ì”¨ë°œ'], count: 0, found: new Set() },
        anxiety: { keywords: ['ê±±ì •', 'ë¬´ì„œ', 'ë¶ˆì•ˆ', 'ë‘ë ¤', 'ê¸´ì¥', 'ë‹¹í™©', 'ì´ˆì¡°', 'ë¯¼ë§', 'ì¡°ì‹¬ìŠ¤ëŸ¬', 'ë‚¯ì„¤', 'í˜¼ë€', 'ì˜ëª»ë ê¹Œë´', 'ê²ë‚˜', 'ë–¨ë ¤'], count: 0, found: new Set() }
      };
      history.forEach(msg => {
        if (typeof msg.content !== 'string') return;
        const text = msg.content.toLowerCase();
        for (const emotionKey in emotions) {
          emotions[emotionKey].keywords.forEach(word => {
            if (text.includes(word)) {
              emotions[emotionKey].count++;
              emotions[emotionKey].found.add(word);
            }
          });
        }
      });
      return {
        joy: { count: emotions.joy.count, keywords: Array.from(emotions.joy.found) },
        sadness: { count: emotions.sadness.count, keywords: Array.from(emotions.sadness.found) },
        anger: { count: emotions.anger.count, keywords: Array.from(emotions.anger.found) },
        anxiety: { count: emotions.anxiety.count, keywords: Array.from(emotions.anxiety.found) },
      };
    }

    function displaySentimentAnalysis(conversationHistory, storedAudioLevel) {
        const conversationDisplaySentimentEl = document.getElementById('conversation-display-sentiment');
        const audioLevelDisplaySentimentEl = document.getElementById('audio-level-display-sentiment');
        const emotionTextDetailsDisplayEl = document.getElementById('emotion-text-details');
        const emotionChartCanvasEl = document.getElementById('emotionChart').getContext('2d');

        let conversationHtml = '';
        if (conversationHistory && conversationHistory.length > 0) {
            conversationHistory.forEach(msg => {
                const safeContent = (msg.content || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                const speakerClass = msg.role === 'user' ? 'user-message' : (msg.role === 'assistant' ? 'assistant-message' : 'system-message');
                const speakerName = msg.role === 'user' ? 'ë¯¼í›„' : (msg.role === 'assistant' ? 'AI ì¹œêµ¬' : 'ì•ˆë‚´');
                conversationHtml += `<p class="${speakerClass}"><strong class="${speakerClass.split('-')[0] + '-strong'}">${speakerName}:</strong> ${safeContent}</p>`;
            });
            conversationDisplaySentimentEl.innerHTML = conversationHtml;
        } else {
            conversationDisplaySentimentEl.innerHTML = '<p>í‘œì‹œí•  ëŒ€í™” ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        if (storedAudioLevel) {
            const safeAudioLevel = storedAudioLevel.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            audioLevelDisplaySentimentEl.innerHTML = `<p>ë§ˆì§€ë§‰ ëŒ€í™”ì˜ ì†Œë¦¬ í¬ê¸° (0-1): <span>${safeAudioLevel}</span></p>`;
        } else {
            audioLevelDisplaySentimentEl.innerHTML = '<p>ì €ì¥ëœ ì†Œë¦¬ í¬ê¸° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        if (conversationHistory && conversationHistory.length > 0) {
            const emotionAnalysis = analyzeOverallEmotions(conversationHistory);
            let summaryTextHtml = '<ul>';
            summaryTextHtml += `<li class="joy"><strong>ê¸°ì¨ (Joy):</strong> <span>${emotionAnalysis.joy.count}</span>íšŒ</li>`;
            summaryTextHtml += `<li class="sadness"><strong>ìŠ¬í”” (Sadness):</strong> <span>${emotionAnalysis.sadness.count}</span>íšŒ</li>`;
            summaryTextHtml += `<li class="anger"><strong>ë¶„ë…¸ (Anger):</strong> <span>${emotionAnalysis.anger.count}</span>íšŒ</li>`;
            summaryTextHtml += `<li class="anxiety"><strong>ë¶ˆì•ˆ (Anxiety/Fear):</strong> <span>${emotionAnalysis.anxiety.count}</span>íšŒ</li>`;
            summaryTextHtml += '</ul>';
            emotionTextDetailsDisplayEl.innerHTML = summaryTextHtml;

            if (window.mySentimentChart instanceof Chart) {
                window.mySentimentChart.destroy();
            }
            window.mySentimentChart = new Chart(emotionChartCanvasEl, {
                type: 'bar',
                data: {
                    labels: ['ê¸°ì¨', 'ìŠ¬í””', 'ë¶„ë…¸', 'ë¶ˆì•ˆ'],
                    datasets: [{
                        label: 'ê°ì • í‘œí˜„ ë¹ˆë„',
                        data: [emotionAnalysis.joy.count, emotionAnalysis.sadness.count, emotionAnalysis.anger.count, emotionAnalysis.anxiety.count],
                        backgroundColor: ['rgba(255, 206, 86, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(153, 102, 255, 0.7)'],
                        borderColor: ['rgba(255, 206, 86, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)', 'rgba(153, 102, 255, 1)'],
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { x: { beginAtZero: true, ticks: { stepSize: 1, font: { size: 10 } } }, y: { beginAtZero: true, ticks: { font: { size: 12 } } } },
                    plugins: { legend: { display: false }, title: { display: true, text: 'ëŒ€í™” ì¤‘ ì£¼ìš” ê°ì • í‘œí˜„ ë¹ˆë„', font: { size: 14 } } }
                }
            });
        } else {
            emotionTextDetailsDisplayEl.innerHTML = '<p>ë¶„ì„í•  ëŒ€í™” ë‚´ìš©ì´ ì—†ì–´ ê°ì • ë¶„ì„ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    }

    const strongEmotionKeywords = {
        joy: ['ë§¤ìš° í–‰ë³µ', 'ë„ˆë¬´ ì‹ ë‚˜', 'ì™„ì „ ìµœê³ ', 'ì •ë§ ê°ì‚¬', 'ì™„ì „ ìµœê³ ì•¼'],
        sadness: ['ë„ˆë¬´ ìŠ¬í¼', 'ì •ë§ ìš°ìš¸', 'ê¹Šì€ ìƒì²˜', 'ë„ˆë¬´ ì†ìƒí•´', 'ì™„ì „ í—ˆì „'],
        anger: ['ì”¨ë°œ', 'ì¡´ë‚˜', 'ê°œë¹¡', 'ë¯¸ì¹œ', 'ì£½ê² ì–´', 'ë„ˆë¬´ í™”ë‚˜', 'ì§„ì§œ ì§œì¦ë‚˜', 'ë„ˆë¬´ ì–µìš¸í•´', 'ì •ë§ ë‹µë‹µí•´', 'ë„ˆë¬´ ì‹«ì–´'],
        anxiety: ['ë„ˆë¬´ ê±±ì •ë¼', 'ë„ˆë¬´ ë¬´ì„œì›Œ', 'ì •ë§ ë¶ˆì•ˆí•´', 'ë„ˆë¬´ ë‘ë ¤ì›Œ', 'ê·¹ë„ë¡œ ê¸´ì¥', 'ì™„ì „ ë‹¹í™©']
    };
    function isProfanity(text) {
        const profanityList = ['ì”¨ë°œ', 'ì¡´ë‚˜', 'ê°œë¹¡', 'ë¯¸ì¹œ', 'ìƒˆë¼', 'ë³‘ì‹ '];
        return profanityList.some(word => text.toLowerCase().includes(word));
    }
    function selectImportantUtterances(conversationHistory, maxUtterances = 10) {
      const importantUtterances = [];
      const userUtterances = conversationHistory.filter(msg => msg.role === 'user');
      for (const utterance of userUtterances) {
        if (importantUtterances.length >= maxUtterances) break;
        let isImportant = false;
        const text = utterance.content.toLowerCase();
        if (isProfanity(text)) isImportant = true;
        if (!isImportant) {
          for (const emotionType in strongEmotionKeywords) {
            if (strongEmotionKeywords[emotionType].some(keyword => text.includes(keyword))) {
              isImportant = true;
              break;
            }
          }
        }
        if (isImportant) importantUtterances.push(utterance);
      }
      if (importantUtterances.length === 0 && userUtterances.length > 0) {
          return userUtterances.slice(-Math.min(maxUtterances, userUtterances.length));
      }
      if (importantUtterances.length < maxUtterances && importantUtterances.length < userUtterances.length) {
          const existingContents = new Set(importantUtterances.map(u => u.content));
          for (let i = userUtterances.length - 1; i >= 0; i--) {
              if (importantUtterances.length >= maxUtterances) break;
              if (!existingContents.has(userUtterances[i].content)) {
                  importantUtterances.push(userUtterances[i]);
                  existingContents.add(userUtterances[i].content);
              }
          }
      }
      return importantUtterances.slice(0, maxUtterances);
    }

    async function displayKeyUtteranceAnalysis(conversationHistory) {
        const resultsContainerKeyEl = document.getElementById('analysis-results-key');
        if (!conversationHistory || conversationHistory.length === 0) {
            resultsContainerKeyEl.innerHTML = '<p class="loading-message">ë¶„ì„í•  ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        const importantUtterances = selectImportantUtterances(conversationHistory);
        if (importantUtterances.length === 0) {
            resultsContainerKeyEl.innerHTML = '<p class="loading-message">ì´ë²ˆ ëŒ€í™”ì—ì„œëŠ” íŠ¹ë³„íˆ ë¶„ì„í•  ë§Œí•œ ì£¼ìš” ë°œí™”ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        resultsContainerKeyEl.innerHTML = ''; 

        for (let i = 0; i < importantUtterances.length; i++) {
            const utterance = importantUtterances[i];
            const card = document.createElement('div');
            card.className = 'important-utterance-card';
            const utteranceHtml = `
                <div class="utterance-text">
                    <p><strong>ë¯¼í›„ì˜ ë§ #${i + 1}:</strong></p>
                    <p>${utterance.content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>
                </div>
                <div class="analysis-section">
                    <h4>ğŸ¤– AI ê°ì • ë¶„ì„:</h4>
                    <div id="gpt-analysis-key-${i}"><p class="placeholder-note">AI ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
                    <h4>ğŸ”Š ìŒì„± íŠ¹ì§• ë¶„ì„ (ì˜ˆì •):</h4>
                    <p class="placeholder-note">ì´ ë°œí™” ì‹œ ëª©ì†Œë¦¬ í¬ê¸°ë‚˜ ê°•ì„¸ì— ëŒ€í•œ ë¶„ì„ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    <h4><0xF0><0x9F><0xAA><0xB2> ì´ì „ ëŒ€í™” íŒ¨í„´ (ì˜ˆì •):</h4>
                    <p class="placeholder-note">ê³¼ê±° ëŒ€í™”ì—ì„œ ìœ ì‚¬í•œ íŒ¨í„´ì´ ìˆì—ˆëŠ”ì§€ì— ëŒ€í•œ ë¶„ì„ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>`;
            card.innerHTML = utteranceHtml;
            resultsContainerKeyEl.appendChild(card);

            try {
                const analysisResult = await getGptResponse(utterance.content, [], { analysisType: 'detailedUtterance' }); 
                
                const gptAnalysisEl = document.getElementById(`gpt-analysis-key-${i}`);
                if (analysisResult && analysisResult.mainEmotion) { 
                    gptAnalysisEl.innerHTML = `
                        <p><strong>ì£¼ìš” ê°ì •:</strong> ${analysisResult.mainEmotion}</p>
                        <p><strong>ê·¸ë ‡ê²Œ ìƒê°í•˜ëŠ” ì´ìœ :</strong> ${analysisResult.reasonForEmotion}</p>
                        <p><strong>ë“œëŸ¬ë‚˜ëŠ” ìƒê°/íƒœë„:</strong> ${analysisResult.underlyingThoughts || 'íŠ¹ë³„íˆ ë“œëŸ¬ë‚˜ëŠ” ì  ì—†ìŒ'}</p>
                        ${analysisResult.profanityAnalysis ? `<p><strong>ìš•ì„¤/ê°•í•œ í‘œí˜„ ë¶„ì„:</strong> ${analysisResult.profanityAnalysis}</p>` : ''}`;
                } else {
                    gptAnalysisEl.innerHTML = `<p class="placeholder-note" style="color:orange;">AI ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì™”ìœ¼ë‚˜, ì˜ˆìƒëœ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (ì‘ë‹µ: ${JSON.stringify(analysisResult)})</p>`;
                }
            } catch (error) {
                console.error(`GPT ë¶„ì„ ì‹¤íŒ¨ (ë¬¸ë‹¨ ${i + 1}):`, error);
                const gptAnalysisEl = document.getElementById(`gpt-analysis-key-${i}`);
                gptAnalysisEl.innerHTML = `<p class="placeholder-note" style="color:red;">AI ê°ì • ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
      setSampleDataForTesting(); 

      const tabs = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');

      const storedConversation = localStorage.getItem('fullConversation');
      const storedAudioLevel = localStorage.getItem('analysisAudioLevel');
      let conversationHistory = [];
      if (storedConversation) {
          try { conversationHistory = JSON.parse(storedConversation); }
          catch (e) { console.error("ì´ˆê¸° ëŒ€í™” ê¸°ë¡ íŒŒì‹± ì˜¤ë¥˜:", e); }
      }

      displaySentimentAnalysis(conversationHistory, storedAudioLevel);
      let keyUtteranceAnalysisLoaded = false;

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(item => item.classList.remove('active'));
          tab.classList.add('active');
          const targetTabContentId = tab.getAttribute('data-tab');
          tabContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === targetTabContentId) {
              content.classList.add('active');
              if (targetTabContentId === 'keyUtteranceAnalysis' && !keyUtteranceAnalysisLoaded) {
                displayKeyUtteranceAnalysis(conversationHistory);
                keyUtteranceAnalysisLoaded = true;
              }
            }
          });
        });
      });

      const saveJournalBtn = document.getElementById('btn-save-journal');
      if (saveJournalBtn) {
        saveJournalBtn.addEventListener('click', () => {
          const emotionData = conversationHistory.length > 0 ? analyzeOverallEmotions(conversationHistory) : null;
          const journalData = {
            conversationHistory: conversationHistory,
            emotions: emotionData ? {
                joy: emotionData.joy.count, sadness: emotionData.sadness.count,
                anger: emotionData.anger.count, anxiety: emotionData.anxiety.count
            } : null,
            audioLevel: storedAudioLevel || 'ì •ë³´ ì—†ìŒ'
          };
          localStorage.setItem('journalEntryData', JSON.stringify(journalData));
          console.log("ê°ì •ì¼ê¸° ë°ì´í„° ì €ì¥:", journalData);
          window.location.href = 'loading.html';
        });
      }
    });
  </script>
</body>
</html>
