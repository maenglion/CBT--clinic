<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=430" />
  <title>ë¯¼í›„ì™€ ëŒ€í™”í•˜ê¸°</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    body {
      font-family: 'KoPubWorld Dotum', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #ffffff;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: calc(100vh - 40px);
      box-sizing: border-box;
    }
    .container {
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .talk-heading {
      font-size: 22px;
      font-weight: bold;
      margin-top: 30px;
      margin-bottom: 10px;
    }
    .guide-text {
      font-size: 15px;
      color: #555;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    #mic-visualizer { /* P5.jsê°€ ì‚¬ìš©í•  ì‹¤ì œ ìº”ë²„ìŠ¤ */
      display: block;
      margin: 0 auto 30px auto;
      width: 280px; 
      height: 280px; 
      background-color: #f0f0f0; /* P5 ë°°ê²½ì´ íˆ¬ëª…í•  ê²½ìš° ëŒ€ë¹„ */
      border-radius: 50%; /* ìº”ë²„ìŠ¤ ìì²´ë„ ë‘¥ê¸€ê²Œ (ì„ íƒ ì‚¬í•­) */
      /* overflow: hidden; P5ê°€ ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ì§ì ‘ ì œì–´í•˜ë¯€ë¡œ ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìŒ */
    }
    .banner-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-top: 20px;
    }
    .banner-btn {
      width: 300px;
      height: 55px;
      font-size: 17px;
      font-weight: bold;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .btn-talk {
      background-color: #FAF07F; 
      color: #333; 
    }
    .btn-talk.active {
      background-color: #FFB6C1; 
      color: white;
    }
    .btn-process { /* ì´ì „ process-btn í´ë˜ìŠ¤ëª… ìœ ì§€ */
      background-color: #D2E9FF; 
      color: #333;
    }
    /* .btn-interaction.analysis-ready ì™€ ê°™ì€ ë‹¤ë¥¸ ë²„íŠ¼ ìƒíƒœ ìŠ¤íƒ€ì¼ì€ analysis.html ë˜ëŠ” ë‹¤ë¥¸ í˜ì´ì§€ì— ìˆì„ ìˆ˜ ìˆìŒ */

    .transcript-box {
      margin-top: 30px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 8px;
      min-height: 50px; /* ì´ì „ talk.htmlì˜ ê°’ ìœ ì§€ */
      font-size: 15px;
      color: #333;
      line-height: 1.5;
      text-align: left;
      border: 1px solid #eee;
      width: 100%;
      box-sizing: border-box;
      white-space: pre-wrap; /* ì—¬ëŸ¬ ì¤„ í‘œì‹œë¥¼ ìœ„í•´ ì¶”ê°€ */
    }
    .tts-warning {
      color: #d9534f;
      font-size: 0.9em;
      padding: 10px;
      background-color: #f2dede;
      border: 1px solid #ebccd1;
      border-radius: 4px;
      margin-bottom: 15px;
      text-align: center;
    }
    /* @import url('https://webfontworld.github.io/kopus/KoPubWorldDotum.css'); */
  </style>
</head>
<body>
  <main class="container">
    <div id="tts-status-container"></div>
    <h1 class="talk-heading">ë¯¼í›„, ì§€ê¸ˆ ê¸°ë¶„ì€ ì–´ë•Œ?</h1>
    <p id="guide-text" class="guide-text">ëŒ€í™”í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ì´ì•¼ê¸°í•´ë³´ì.<br>ë‹¤ ë§ˆì¹˜ë©´ [ëŒ€í™” ë¶„ì„í•˜ê¸°]ë¥¼ ëˆŒëŸ¬ì¤˜.</p>

    <canvas id="mic-visualizer"></canvas>

    <div class="banner-wrapper">
      <button id="talk-btn" class="banner-btn btn-talk">ëŒ€í™”í•˜ê¸°</button>
      <button id="process-btn" class="banner-btn btn-process">ëŒ€í™” ë¶„ì„í•˜ê¸°</button> 
    </div>

    <div id="transcript" class="transcript-box">ì—¬ê¸°ì— ìŒì„± ì¸ì‹ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
  </main>

  <script type="module">
    import { startSTT, stopSTT } from './js/stt.js';
    import { startTTS } from './js/tts.js'; // TTS ì‚¬ìš© ì‹œ ì£¼ì„ í•´ì œ
    import { getGptResponse } from './js/gpt-dialog.js'; // GPT ì‚¬ìš© ì‹œ ì£¼ì„ í•´ì œ
    // visualizer_p5.jsë¡œ ë³€ê²½
    import { startVisualizer, stopVisualizer } from './js/visualizer_p5.js';

    const talkBtn = document.getElementById('talk-btn');
    // 'process-btn' ë˜ëŠ” 'interaction-btn' ë“± ì‹¤ì œ HTMLì˜ IDì™€ ì¼ì¹˜ì‹œì¼œì•¼ í•¨
    const processBtn = document.getElementById('process-btn'); 
    const transcriptEl = document.getElementById('transcript');
    const guideTextEl = document.getElementById('guide-text'); // ê°€ì´ë“œ í…ìŠ¤íŠ¸ ìš”ì†Œ
    const canvasForVisualizer = document.getElementById('mic-visualizer'); // P5.jsìš© ìº”ë²„ìŠ¤
    const ttsStatusContainer = document.getElementById('tts-status-container');

    let isRecording = false;
    let ttsGenerallySupported = true;
    let conversationHistory = []; // ì—°ì† ëŒ€í™”ë¥¼ ìœ„í•´ í•„ìš”
    let turnCount = 0; // ì—°ì† ëŒ€í™”ë¥¼ ìœ„í•´ í•„ìš”
    const MAX_TURNS_BEFORE_ANALYSIS = 3; // ì—°ì† ëŒ€í™”ë¥¼ ìœ„í•´ í•„ìš”

    window.addEventListener('DOMContentLoaded', () => {
       // talk.html ë¡œë“œ ì‹œ localStorageì—ì„œ ì´ì–´í•  ëŒ€í™”ê°€ ìˆëŠ”ì§€ í™•ì¸
       const continueMode = localStorage.getItem('conversationMode');
       const historyToContinue = localStorage.getItem('continueConversationHistory');

       if (continueMode === 'continue' && historyToContinue) {
           try {
               conversationHistory = JSON.parse(historyToContinue);
               // turnCount = ì´ì „ í„´ ìˆ˜ (í•„ìš”ì‹œ ì €ì¥ ë° ë¡œë“œ)
               updateTranscriptDisplay("ì´ì „ ëŒ€í™”ì— ì´ì–´ì„œ ì‹œì‘í•©ë‹ˆë‹¤.", "system_message");
               guideTextEl.innerHTML = "ì´ì „ ëŒ€í™”ì— ì´ì–´ì„œ ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”.<br>[ëŒ€í™”í•˜ê¸°]ë¥¼ ëˆ„ë¥´ê±°ë‚˜, [ìˆ¨ ëŒë¦¬ê¸°]ë¡œ AIì˜ ë‹µë³€ì„ ë“¤ì–´ë³´ì„¸ìš”.";
           } catch (e) {
               console.error("ì´ì–´í•˜ê¸° ëŒ€í™” ê¸°ë¡ íŒŒì‹± ì˜¤ë¥˜:", e);
               conversationHistory = []; // ì˜¤ë¥˜ ì‹œ ì´ˆê¸°í™”
               updateTranscriptDisplay("ëŒ€í™”í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¯¼í›„ì™€ ì´ì•¼ê¸°í•´ë³´ì„¸ìš”!", "initial_empty");
           }
           localStorage.removeItem('continueConversationHistory');
           localStorage.removeItem('conversationMode');
       } else {
           localStorage.removeItem('userSpeech');
           localStorage.removeItem('fullConversation'); // ì´ì „ ë¶„ì„ìš© ëŒ€í™” ê¸°ë¡ ì‚­ì œ
           updateTranscriptDisplay("ëŒ€í™”í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¯¼í›„ì™€ ì´ì•¼ê¸°í•´ë³´ì„¸ìš”!", "initial_empty");
       }
       
       canvasForVisualizer.width = 280; // P5 Canvas í¬ê¸° ëª…ì‹œì  ì„¤ì •
       canvasForVisualizer.height = 280;

       if (!window.speechSynthesis) {
           ttsGenerallySupported = false;
           // (TTS ë¯¸ì§€ì› UI ì²˜ë¦¬ - ì´ì „ ì½”ë“œì™€ ë™ì¼)
       }
    });
    
    // ëŒ€í™” ë‚´ìš© í‘œì‹œ í•¨ìˆ˜ (analysis.htmlê³¼ ìœ ì‚¬í•˜ê²Œ, ë˜ëŠ” ë” ê°„ë‹¨í•˜ê²Œ)
    function updateTranscriptDisplay(newText = "", role = "system_message") {
        if (role === "user" && newText) {
            conversationHistory.push({ role: "user", content: newText });
        } else if (role === "assistant" && newText) {
            conversationHistory.push({ role: "assistant", content: newText });
        } else if (role === "system_error" && newText) {
             conversationHistory.push({ role: "system", content: `[ì˜¤ë¥˜] ${newText}` });
        } else if (role === "system_message" && newText) {
             conversationHistory.push({ role: "system", content: `[ì•ˆë‚´] ${newText}` });
        }


        let displayHtml = "";
        conversationHistory.forEach(msg => {
            const speaker = msg.role === 'user' ? 'ë¯¼í›„' : (msg.role === 'assistant' ? 'AI ì¹œêµ¬' : 'ì•ˆë‚´');
            const safeContent = (msg.content || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            displayHtml += `<p><strong>${speaker}:</strong> ${safeContent}</p>`;
        });
        
        if (conversationHistory.length === 0 && role !== "initial_empty") {
             transcriptEl.innerHTML = "<p>ëŒ€í™”í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¯¼í›„ì™€ ì´ì•¼ê¸°í•´ë³´ì„¸ìš”!</p>";
        } else if (role === "initial_empty") {
             transcriptEl.innerHTML = "<p>ì—¬ê¸°ì— ëŒ€í™” ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>";
        }
        else {
            transcriptEl.innerHTML = displayHtml;
        }
        transcriptEl.scrollTop = transcriptEl.scrollHeight;
    }


    // "ëŒ€í™”í•˜ê¸°" / "ì ê¹ ì‰¬ê¸°" ë²„íŠ¼ í† ê¸€ ë¡œì§
    talkBtn.addEventListener('click', async () => {
      if (!isRecording) {
        isRecording = true;
        talkBtn.textContent = 'ì ê¹ ì‰¬ê¸°';
        talkBtn.classList.add('active');
        // í˜„ì¬ ëŒ€í™” ê¸°ë¡ì„ ìœ ì§€í•˜ë©´ì„œ ë§ˆì´í¬ ì¤€ë¹„ ë©”ì‹œì§€ ì¶”ê°€
        transcriptEl.innerHTML = conversationHistory.map(msg => `<p><strong>${msg.role === 'user' ? 'ë¯¼í›„' : 'AI ì¹œêµ¬'}:</strong> ${msg.content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>`).join('') + "<p>[ì•ˆë‚´] ë§ˆì´í¬ ì¤€ë¹„ ì¤‘...ğŸ™ï¸</p>";
        transcriptEl.scrollTop = transcriptEl.scrollHeight;
        try {
          await startVisualizer(canvasForVisualizer); // P5.js ì‹œê°í™” ì‹œì‘
          startSTT((text) => {
            if (text) {
              localStorage.setItem('userSpeech', text); // í˜„ì¬ ë°œí™” ì €ì¥
              // STT ê²°ê³¼ë¥¼ ì¦‰ì‹œ ëŒ€í™”ì°½ì— ë°˜ì˜ (ì‚¬ìš©ì ë°œí™”ë¡œ)
              transcriptEl.innerHTML = conversationHistory.map(msg => `<p><strong>${msg.role === 'user' ? 'ë¯¼í›„' : 'AI ì¹œêµ¬'}:</strong> ${msg.content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>`).join('') + `<p><strong>ë¯¼í›„ (ë§í•˜ëŠ” ì¤‘):</strong> "${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}"</p>`;
              transcriptEl.scrollTop = transcriptEl.scrollHeight;
            } else if (isRecording) {
              updateTranscriptDisplay("ìŒ... ì˜ ëª» ë“¤ì—ˆì–´. ë‹¤ì‹œ ë§í•´ì¤„ë˜?", "system_message");
            }
          });
          updateTranscriptDisplay("ë“£ê³  ìˆì–´ìš”... ë§í•´ì£¼ì„¸ìš”! ğŸ˜Š", "system_message");
        } catch (err) {
          isRecording = false;
          talkBtn.textContent = 'ëŒ€í™”í•˜ê¸°';
          talkBtn.classList.remove('active');
          updateTranscriptDisplay(`ë§ˆì´í¬ë¥¼ ì‹œì‘í•˜ì§€ ëª»í–ˆì–´ìš”. ğŸ˜¥ ê¶Œí•œì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (${err.message})`, "system_error");
          stopVisualizer();
        }
      } else { // ë…¹ìŒ ì¤‘ì§€ ("ì ê¹ ì‰¬ê¸°" í´ë¦­)
        isRecording = false;
        talkBtn.textContent = 'ëŒ€í™”í•˜ê¸°';
        talkBtn.classList.remove('active');
        stopSTT();
        stopVisualizer();
        const lastUserSpeech = localStorage.getItem('userSpeech');
        if (lastUserSpeech) {
             // "ìˆ¨ ëŒë¦¬ê¸°" ë²„íŠ¼ì„ ëˆ„ë¥´ê¸° ì „ê¹Œì§€ëŠ” userSpeechë¥¼ historyì— ë„£ì§€ ì•ŠìŒ
             updateTranscriptDisplay(`"${lastUserSpeech}" ë¼ê³  ë§í–ˆêµ¬ë‚˜! ì´ì œ [ìˆ¨ ëŒë¦¬ê¸°]ë¥¼ ëˆŒëŸ¬ AI ì¹œêµ¬ì™€ ì´ì•¼ê¸°í•˜ê±°ë‚˜, [ëŒ€í™”í•˜ê¸°]ë¥¼ ëˆŒëŸ¬ ë” ë§í•  ìˆ˜ ìˆì–´.`, "system_message");
        } else {
            updateTranscriptDisplay("ëŒ€í™”ë¥¼ ì ì‹œ ë©ˆì·„ì–´ìš”.", "system_message");
        }
      }
    });

    // "ìˆ¨ ëŒë¦¬ê¸°" ë˜ëŠ” "ëŒ€í™” ë¶„ì„í•˜ê¸°" ë²„íŠ¼ ë¡œì§ (ì´ì „ talk.htmlì˜ interactionBtn ë¡œì§ ì°¸ê³ )
    processBtn.addEventListener('click', async () => {
        // ì´ ë²„íŠ¼ì˜ ì—­í• ì´ "ëŒ€í™” ë¶„ì„í•˜ê¸°"ë¡œ ê³ ì •ëœ ê²½ìš° (ì´ì „ ì½”ë“œ)
        // ë˜ëŠ” "ìˆ¨ ëŒë¦¬ê¸°" -> "ëŒ€í™” ë¶„ì„í•˜ê¸°"ë¡œ ë³€í•˜ëŠ” ê²½ìš° (ë” ë³µì¡í•œ ë¡œì§)
        // í˜„ì¬ ì½”ë“œì—ì„œëŠ” "ëŒ€í™” ë¶„ì„í•˜ê¸°"ë¡œ ê°€ì •í•˜ê³  analysis.htmlë¡œ ë°ì´í„° ì „ë‹¬

        if (isRecording) {
            isRecording = false;
            talkBtn.textContent = 'ëŒ€í™”í•˜ê¸°';
            talkBtn.classList.remove('active');
            stopSTT();
            stopVisualizer();
        }

        const currentUserSpeech = localStorage.getItem('userSpeech');
        if (currentUserSpeech) { // ë§ˆì§€ë§‰ ë°œí™”ê°€ ìˆë‹¤ë©´ ëŒ€í™” ê¸°ë¡ì— ì¶”ê°€
            updateTranscriptDisplay(currentUserSpeech, "user");
            localStorage.removeItem('userSpeech'); // ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ì‚­ì œ
        }

        if (conversationHistory.length === 0) {
            alert("ë¶„ì„í•  ëŒ€í™” ë‚´ìš©ì´ ì—†ì–´ìš”. ë¨¼ì € 'ëŒ€í™”í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì´ì•¼ê¸°ë¥¼ ë…¹ìŒí•´ì£¼ì„¸ìš”.");
            updateTranscriptDisplay("ë¶„ì„í•  ëŒ€í™” ë‚´ìš©ì´ ì—†ì–´ìš”.", "system_message");
            return;
        }
        
        // ì „ì²´ ëŒ€í™” ê¸°ë¡ì„ analysis.htmlë¡œ ì „ë‹¬
        localStorage.setItem('fullConversation', JSON.stringify(conversationHistory));
        // P5.js ì‹œê°í™”ì—ì„œ ì €ì¥í•œ ì˜¤ë””ì˜¤ ë ˆë²¨ë„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ
        const lastAmplitude = localStorage.getItem('currentAmplitude');
        if (lastAmplitude) {
            localStorage.setItem('analysisAudioLevel', lastAmplitude);
        }

        console.log("ğŸš€ ëŒ€í™” ë¶„ì„í•˜ê¸° ë²„íŠ¼ í´ë¦­ë¨. analysis.htmlë¡œ ì´ë™í•©ë‹ˆë‹¤.");
        window.location.href = 'analysis.html';
    });

    // TTS ì‹œë„ ë° ì˜¤ë¥˜ ì²˜ë¦¬ í—¬í¼ í•¨ìˆ˜
    async function attemptTTS(textToSpeak) {
        if (!ttsGenerallySupported || !textToSpeak || textToSpeak.trim() === "" || textToSpeak.trim() === "...") {
            return;
        }
        try {
            await startTTS(textToSpeak); // startTTSê°€ Promiseë¥¼ ë°˜í™˜í•œë‹¤ê³  ê°€ì •
        } catch (ttsError) {
            console.warn(`TTS ì¬ìƒ ì¤‘ ì˜¤ë¥˜: "${textToSpeak.substring(0,30)}..."`, ttsError.message);
            // (TTS ë¯¸ì§€ì› UI ì²˜ë¦¬ - ì´ì „ ì½”ë“œì™€ ë™ì¼)
        }
    }

  </script>
</body>
</html>
